<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semantic Q&A Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .answer-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .answer-box h4 {
            margin-top: 0;
            color: #495057;
        }
        
        .metadata {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 10px;
        }
        
        .facts {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .facts h5 {
            margin-top: 0;
            color: #856404;
        }
        
        .fact-item {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Semantic Q&A System Integration Test</h1>
        <p>This page demonstrates the semantic question-answering system using a tiny analyzer model for embeddings and contextual responses.</p>
    </div>

    <div class="container">
        <div class="section">
            <h2>1. System Status</h2>
            <div id="systemStatus" class="status info">
                <div class="loading"></div> Initializing system...
            </div>
            <button id="initializeBtn" onclick="initializeSystem()">Initialize System</button>
            <button id="resetBtn" onclick="resetSystem()" disabled>Reset System</button>
        </div>
    </div>

    <div class="grid">
        <div class="container">
            <div class="section">
                <h2>2. Context Input</h2>
                <textarea id="contextInput" placeholder="Enter context text to index for semantic search...">Serhii has been working with React for 4+ years. He is a Senior Product Manager at TechCorp, where he focuses on product strategy and innovation. Serhii has extensive experience with JavaScript, TypeScript, and Node.js development. He specializes in building scalable web applications and leading cross-functional teams. Serhii graduated from University of Technology with a Computer Science degree and has been in the tech industry for over 8 years. He is passionate about emerging technologies and enjoys mentoring junior developers.</textarea>
                <br>
                <button id="indexBtn" onclick="indexContext()" disabled>Index Context</button>
                <div id="indexStatus"></div>
            </div>
        </div>

        <div class="container">
            <div class="section">
                <h2>3. Question & Answer</h2>
                <input type="text" id="questionInput" placeholder="Ask a question about the context..." value="Does Serhii have experience with React?">
                <button id="askBtn" onclick="askQuestion()" disabled>Ask Question</button>
                <div id="questionStatus"></div>
                <div id="answerContainer"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h2>4. Batch Questions</h2>
            <div>
                <button onclick="askPredefinedQuestions()" id="batchBtn" disabled>Ask Sample Questions</button>
                <button onclick="clearResults()">Clear Results</button>
            </div>
            <div id="batchResults"></div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h2>5. Semantic Search</h2>
            <input type="text" id="searchInput" placeholder="Search for similar content..." value="product management">
            <button id="searchBtn" onclick="semanticSearch()" disabled>Search</button>
            <div id="searchResults"></div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h2>6. System Performance</h2>
            <div id="performanceMetrics"></div>
            <button onclick="updatePerformanceMetrics()">Refresh Metrics</button>
        </div>
    </div>

    <script type="module">
        import SemanticQAManager from '../src/scripts/modules/semantic-qa/index.js';

        let qaManager = null;
        let isSystemReady = false;

        // Make functions globally available
        window.qaManager = null;
        window.isSystemReady = false;

        window.initializeSystem = async function() {
            const statusDiv = document.getElementById('systemStatus');
            const initBtn = document.getElementById('initializeBtn');
            
            try {
                statusDiv.innerHTML = '<div class="loading"></div> Initializing semantic Q&A system...';
                statusDiv.className = 'status info';
                initBtn.disabled = true;

                qaManager = new SemanticQAManager();
                await qaManager.initialize();
                
                window.qaManager = qaManager;
                isSystemReady = true;
                window.isSystemReady = true;

                statusDiv.innerHTML = '‚úÖ System initialized successfully!';
                statusDiv.className = 'status success';
                
                // Enable other buttons
                document.getElementById('indexBtn').disabled = false;
                document.getElementById('resetBtn').disabled = false;
                
                updatePerformanceMetrics();
                
            } catch (error) {
                console.error('Initialization failed:', error);
                statusDiv.innerHTML = `‚ùå Initialization failed: ${error.message}`;
                statusDiv.className = 'status error';
                initBtn.disabled = false;
            }
        };

        window.resetSystem = function() {
            if (qaManager) {
                qaManager.reset();
                
                // Reset UI
                document.getElementById('systemStatus').innerHTML = 'üîÑ System reset. Click Initialize to restart.';
                document.getElementById('systemStatus').className = 'status info';
                document.getElementById('indexStatus').innerHTML = '';
                document.getElementById('answerContainer').innerHTML = '';
                document.getElementById('batchResults').innerHTML = '';
                document.getElementById('searchResults').innerHTML = '';
                
                // Disable buttons
                document.getElementById('indexBtn').disabled = true;
                document.getElementById('askBtn').disabled = true;
                document.getElementById('batchBtn').disabled = true;
                document.getElementById('searchBtn').disabled = true;
                document.getElementById('initializeBtn').disabled = false;
                
                isSystemReady = false;
                window.isSystemReady = false;
                
                updatePerformanceMetrics();
            }
        };

        window.indexContext = async function() {
            if (!isSystemReady) return;
            
            const contextText = document.getElementById('contextInput').value.trim();
            const statusDiv = document.getElementById('indexStatus');
            const indexBtn = document.getElementById('indexBtn');
            
            if (!contextText) {
                statusDiv.innerHTML = '<div class="status error">Please enter context text</div>';
                return;
            }
            
            try {
                statusDiv.innerHTML = '<div class="status info"><div class="loading"></div> Indexing context...</div>';
                indexBtn.disabled = true;
                
                const result = await qaManager.indexContext(contextText);
                
                statusDiv.innerHTML = `<div class="status success">‚úÖ Context indexed successfully! Created ${result.chunkCount} chunks in ${result.indexingTime}ms</div>`;
                
                // Enable Q&A buttons
                document.getElementById('askBtn').disabled = false;
                document.getElementById('batchBtn').disabled = false;
                document.getElementById('searchBtn').disabled = false;
                
                updatePerformanceMetrics();
                
            } catch (error) {
                console.error('Indexing failed:', error);
                statusDiv.innerHTML = `<div class="status error">‚ùå Indexing failed: ${error.message}</div>`;
            } finally {
                indexBtn.disabled = false;
            }
        };

        window.askQuestion = async function() {
            if (!isSystemReady) return;
            
            const question = document.getElementById('questionInput').value.trim();
            const statusDiv = document.getElementById('questionStatus');
            const answerDiv = document.getElementById('answerContainer');
            const askBtn = document.getElementById('askBtn');
            
            if (!question) {
                statusDiv.innerHTML = '<div class="status error">Please enter a question</div>';
                return;
            }
            
            try {
                statusDiv.innerHTML = '<div class="status info"><div class="loading"></div> Processing question...</div>';
                askBtn.disabled = true;
                answerDiv.innerHTML = '';
                
                const result = await qaManager.askQuestion(question);
                
                statusDiv.innerHTML = `<div class="status success">‚úÖ Question processed in ${result.responseTime}ms</div>`;
                
                // Display answer
                answerDiv.innerHTML = createAnswerHTML(result);
                
                updatePerformanceMetrics();
                
            } catch (error) {
                console.error('Question processing failed:', error);
                statusDiv.innerHTML = `<div class="status error">‚ùå Question processing failed: ${error.message}</div>`;
            } finally {
                askBtn.disabled = false;
            }
        };

        window.askPredefinedQuestions = async function() {
            if (!isSystemReady) return;
            
            const questions = [
                'Does Serhii have experience with React?',
                'What is Serhii\'s role?',
                'How many years of experience does he have?',
                'What technologies does Serhii know?',
                'Where did Serhii study?',
                'What does Serhii specialize in?'
            ];
            
            const resultsDiv = document.getElementById('batchResults');
            const batchBtn = document.getElementById('batchBtn');
            
            try {
                batchBtn.disabled = true;
                resultsDiv.innerHTML = '<div class="status info"><div class="loading"></div> Processing batch questions...</div>';
                
                const results = await qaManager.askQuestions(questions);
                
                let html = '<h3>Batch Question Results</h3>';
                results.forEach((result, index) => {
                    html += `
                        <div class="answer-box">
                            <h4>Q${index + 1}: ${questions[index]}</h4>
                            ${createAnswerHTML(result)}
                        </div>
                    `;
                });
                
                resultsDiv.innerHTML = html;
                updatePerformanceMetrics();
                
            } catch (error) {
                console.error('Batch processing failed:', error);
                resultsDiv.innerHTML = `<div class="status error">‚ùå Batch processing failed: ${error.message}</div>`;
            } finally {
                batchBtn.disabled = false;
            }
        };

        window.semanticSearch = async function() {
            if (!isSystemReady) return;
            
            const query = document.getElementById('searchInput').value.trim();
            const resultsDiv = document.getElementById('searchResults');
            const searchBtn = document.getElementById('searchBtn');
            
            if (!query) {
                resultsDiv.innerHTML = '<div class="status error">Please enter a search query</div>';
                return;
            }
            
            try {
                searchBtn.disabled = true;
                resultsDiv.innerHTML = '<div class="status info"><div class="loading"></div> Searching...</div>';
                
                const results = await qaManager.semanticSearch(query, 3);
                
                let html = '<h3>Semantic Search Results</h3>';
                if (results.length === 0) {
                    html += '<p>No similar content found.</p>';
                } else {
                    results.forEach((result, index) => {
                        html += `
                            <div class="answer-box">
                                <h4>Result ${index + 1} (Similarity: ${(result.similarity * 100).toFixed(1)}%)</h4>
                                <p><strong>Text:</strong> ${result.chunk.text}</p>
                                <div class="metadata">
                                    <strong>Word Count:</strong> ${result.chunk.wordCount} | 
                                    <strong>Source:</strong> ${result.chunk.metadata.source || 'unknown'}
                                </div>
                            </div>
                        `;
                    });
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Search failed:', error);
                resultsDiv.innerHTML = `<div class="status error">‚ùå Search failed: ${error.message}</div>`;
            } finally {
                searchBtn.disabled = false;
            }
        };

        window.clearResults = function() {
            document.getElementById('batchResults').innerHTML = '';
            document.getElementById('answerContainer').innerHTML = '';
            document.getElementById('searchResults').innerHTML = '';
        };

        window.updatePerformanceMetrics = function() {
            const metricsDiv = document.getElementById('performanceMetrics');
            
            if (!qaManager) {
                metricsDiv.innerHTML = '<p>System not initialized</p>';
                return;
            }
            
            const status = qaManager.getStatus();
            
            metricsDiv.innerHTML = `
                <div class="answer-box">
                    <h4>System Status</h4>
                    <p><strong>Initialized:</strong> ${status.isInitialized ? '‚úÖ' : '‚ùå'}</p>
                    <p><strong>Context Indexed:</strong> ${status.hasIndexedContext ? '‚úÖ' : '‚ùå'}</p>
                    ${status.contextInfo ? `
                        <p><strong>Chunks:</strong> ${status.contextInfo.chunkCount}</p>
                        <p><strong>Indexed At:</strong> ${new Date(status.contextInfo.indexedAt).toLocaleTimeString()}</p>
                    ` : ''}
                    
                    <h5>Performance Metrics</h5>
                    <p><strong>Total Queries:</strong> ${status.performanceMetrics.totalQueries}</p>
                    <p><strong>Average Response Time:</strong> ${status.performanceMetrics.avgResponseTime.toFixed(2)}ms</p>
                    
                    <h5>Cache Statistics</h5>
                    <p><strong>Embedding Cache Size:</strong> ${status.embeddingService.size}</p>
                    <p><strong>Indexed Chunks:</strong> ${status.similarityMatcher.indexedChunks}</p>
                </div>
            `;
        };

        function createAnswerHTML(result) {
            let html = `
                <div class="answer-box">
                    <p><strong>Answer:</strong> ${result.answer}</p>
                    <div class="metadata">
                        <strong>Confidence:</strong> ${(result.confidence * 100).toFixed(1)}% | 
                        <strong>Method:</strong> ${result.method} | 
                        <strong>Response Time:</strong> ${result.responseTime}ms
                    </div>
            `;
            
            if (result.facts && result.facts.length > 0) {
                html += `
                    <div class="facts">
                        <h5>Supporting Facts:</h5>
                        ${result.facts.map(fact => `
                            <div class="fact-item">
                                <strong>Fact:</strong> ${fact.text}
                                <br><small>Type: ${fact.type} | Relevance: ${(fact.relevance * 100).toFixed(1)}%</small>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        // Auto-initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, ready for initialization');
        });
    </script>
</body>
</html>